import React, { useEffect, useState, useRef } from "react";

// Single-file React component for the game "บอร์ดเกมคณิตคิดสนุก Setup!"
// Usage:
// - Paste this file into a React project (Create React App, Vite + React).
// - Tailwind CSS classes are used. If you don't have Tailwind, basic inline styles are included so it still works.
// - This is a single-component demo. For production, split into smaller components.

export default function MathBoardSetup() {
  // Setup states
  const [stage, setStage] = useState("choosePlayers"); // choosePlayers -> chooseLevel -> choosePlayerNumber -> action -> question -> result
  const [playerCount, setPlayerCount] = useState(2);
  const [level, setLevel] = useState("m1"); // m1 or m2
  const [currentPlayerIndex, setCurrentPlayerIndex] = useState(0); // 0-based
  const [players, setPlayers] = useState([]); // {score, points}
  const [actionPickerOpenFor, setActionPickerOpenFor] = useState(null);

  // Question flow
  const [pressureCard, setPressureCard] = useState({}); // map playerIndex -> boolean (has more pressure?)
  const [attemptsLeft, setAttemptsLeft] = useState(5);
  const [maxAttempts, setMaxAttempts] = useState(5);

  const [currentQuestion, setCurrentQuestion] = useState(null);
  const [questionTimer, setQuestionTimer] = useState(0); // seconds
  const timerRef = useRef(null);
  const [answerInput, setAnswerInput] = useState("");
  const [message, setMessage] = useState("");

  // Utility: topics lists in order for each level
  const topicsM1 = [
    "จำนวนเต็ม",
    "การสร้างทางเรขาคณิต",
    "เลขยกกำลัง",
    "ทศนิยมและเศษส่วน",
    "รูปเรขาคณิต 2 มิติและ 3 มิติ",
    "สมการเชิงเส้นตัวแปรเดียว",
    "อัตราส่วน สัดส่วน และร้อยละ",
    "กราฟและความสัมพันธ์เชิงเส้น",
    "สถิติ",
  ];

  const topicsM2 = [
    "ความเท่ากันทุกประการ",
    "เส้นขนาน",
    "การให้เหตุผลทางเรขาคณิต",
    "การแยกตัวประกอบของพหุนามดีกรีสอง",
    "ทฤษฎีบทพีทาโกรัส",
    "ความรู้เบื้องต้นเกี่ยวกับจำนวนจริง",
    "ปริซึมและทรงกระบอก",
    "การแปลงทางเรขาคณิต",
    "สมบัติของเลขยกกำลัง",
    "พหุนาม",
  ];

  // Initialize players after choosing playerCount
  useEffect(() => {
    const arr = Array.from({ length: playerCount }).map(() => ({ score: 0, points: 0 }));
    setPlayers(arr);
    setPressureCard({});
  }, [playerCount]);

  // Timer effect
  useEffect(() => {
    if (questionTimer <= 0) {
      clearInterval(timerRef.current);
      timerRef.current = null;
      return;
    }
    timerRef.current = setInterval(() => {
      setQuestionTimer((t) => {
        if (t <= 1) {
          clearInterval(timerRef.current);
          timerRef.current = null;
          handleTimeUp();
          return 0;
        }
        return t - 1;
      });
    }, 1000);
    return () => clearInterval(timerRef.current);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [questionTimer]);

  // Core: generate a question based on level
  function generateQuestion() {
    const isM1 = level === "m1";
    const min = isM1 ? 1 : 11;
    const max = isM1 ? 10 : 20;
    const num = Math.floor(Math.random() * (max - min + 1)) + min; // topic index-ish
    const topicIndex = isM1 ? (num - 1) % topicsM1.length : (num - 11) % topicsM2.length;
    const topic = isM1 ? topicsM1[topicIndex] : topicsM2[topicIndex];

    // We'll create a numeric question for most topics so AI evaluation can check closeness.
    // Different templates per topic (simple but educational)
    let q = { prompt: "", answer: null, type: "numeric", tolerance: 0.02 };

    if (isM1) {
      switch (topicIndex) {
        case 0: // จำนวนเต็ม
          const a = randInt(1, 50);
          const b = randInt(1, 50);
          q.prompt = `ผลบวกของ ${a} + ${b} เท่ากับเท่าไร?`;
          q.answer = a + b;
          q.tolerance = 0; // exact
          break;
        case 1: // การสร้างทางเรขาคณิต
          const base = randInt(3, 12);
          const height = randInt(2, 10);
          q.prompt = `พื้นที่ของสามเหลี่ยมที่มีฐาน = ${base} หน่วย และสูง = ${height} หน่วย เท่ากับ (พื้นที่ = ฐาน×สูง÷2) ?`;
          q.answer = (base * height) / 2;
          q.tolerance = 0.01;
          break;
        case 2: // เลขยกกำลัง
          const basePow = randInt(2, 6);
          const exp = randInt(2, 4);
          q.prompt = `ค่า ${basePow}^${exp} เท่ากับเท่าไร?`;
          q.answer = Math.pow(basePow, exp);
          q.tolerance = 0;
          break;
        case 3: // ทศนิยมและเศษส่วน
          const numerator = randInt(1, 9);
          const denominator = randInt(2, 10);
          q.prompt = `แปลงเศษส่วน ${numerator}/${denominator} เป็นทศนิยม (ประมาณค่า 3 ตำแหน่งทศนิยม)`;
          q.answer = parseFloat((numerator / denominator).toFixed(3));
          q.tolerance = 0.005;
          break;
        case 4: // รูปเรขาคณิต 2 มิติและ 3 มิติ
          const side = randInt(2, 12);
          q.prompt = `ปริมาตรของลูกบาศก์ที่มีความยาวด้าน = ${side} หน่วย (V = ด้าน^3) ?`;
          q.answer = Math.pow(side, 3);
          q.tolerance = 0;
          break;
        case 5: // สมการเชิงเส้นตัวแปรเดียว
          const A = randInt(1, 10);
          const B = randInt(1, 20);
          q.prompt = `แก้สมการ: ${A}x + ${B} = 0 หา x`;
          q.answer = -B / A;
          q.tolerance = 0.01;
          break;
        case 6: // อัตราส่วน สัดส่วน และร้อยละ
          const part = randInt(1, 20);
          const whole = randInt(part + 1, 100);
          q.prompt = `${part} จาก ${whole} เท่ากับร้อยละเท่าไร (ปัดเป็นทศนิยม 2 ตำแหน่ง)`;
          q.answer = parseFloat(((part / whole) * 100).toFixed(2));
          q.tolerance = 0.3;
          break;
        case 7: // กราฟและความสัมพันธ์เชิงเส้น
          const m = randInt(-5, 5) || 1;
          const c = randInt(-5, 5);
          const x = randInt(1, 10);
          q.prompt = `สมการเชิงเส้น y = ${m}x + ${c}. เมื่อ x = ${x} ค่า y เท่ากับเท่าไร?`;
          q.answer = m * x + c;
          q.tolerance = 0;
          break;
        case 8: // สถิติ
          const arr = Array.from({ length: 5 }, () => randInt(1, 20));
          const mean = parseFloat((arr.reduce((s, v) => s + v, 0) / arr.length).toFixed(2));
          q.prompt = `ข้อมูลชุดนี้ ${arr.join(", ")} ค่ากลาง (ค่าเฉลี่ย) ปัด 2 ตำแหน่งคือเท่าไร?`;
          q.answer = mean;
          q.tolerance = 0.05;
          break;
        default:
          q.prompt = "คำถามทั่วไป: 1+1 = ?";
          q.answer = 2;
      }
    } else {
      switch (topicIndex) {
        case 0: // ความเท่ากันทุกประการ (congruence)
          const side1 = randInt(3, 10);
          q.prompt = `รูปสามเหลี่ยมสองรูปมีด้านเท่ากันทุกประการ ถ้าด้านหนึ่งของรูปที่ 1 = ${side1} และสัดส่วนของรูปที่ 2 เท่ากับ 1:1 ค่าเดิมของด้านในรูปที่ 2 = ?`;
          q.answer = side1;
          q.tolerance = 0;
          break;
        case 1: // เส้นขนาน
          const angle = randInt(20, 80);
          q.prompt = `ถ้าเส้นขนานถูกตัดโดยเส้นตรงมุมหนึ่งเท่ากับ ${angle} องศา มุมที่มีค่าเท่ากับมุมนี้จะเป็นเท่าไร?`;
          q.answer = angle;
          q.tolerance = 0;
          break;
        case 2: // การให้เหตุผลทางเรขาคณิต (simple numeric)
          const base2 = randInt(4, 12);
          const height2 = randInt(3, 10);
          q.prompt = `พื้นที่สี่เหลี่ยมผืนผ้าที่มีฐาน ${base2} สูง ${height2} เท่ากับเท่าไร?`;
          q.answer = base2 * height2;
          q.tolerance = 0;
          break;
        case 3: // การแยกตัวประกอบของพหุนามดีกรีสอง
          // produce a quadratic with integer roots
          const r1 = randInt(1, 6);
          const r2 = randInt(1, 6);
          const aCoeff = 1;
          // polynomial x^2 - (r1+r2)x + r1*r2
          q.prompt = `พหุนาม x^2 - ${r1 + r2}x + ${r1 * r2} มีรากเท่าไร? (พิมพ์รูปแบบ: r1,r2 หรือประมาณ)`;
          q.answer = [r1, r2];
          q.type = "list";
          q.tolerance = 0;
          break;
        case 4: // ทฤษฎีบทพีทาโกรัส
          const a3 = randInt(3, 10);
          const b3 = randInt(3, 10);
          const c3 = Math.sqrt(a3 * a3 + b3 * b3);
          q.prompt = `ด้านสองด้านของสามเหลี่ยมมุมฉากมีความยาว ${a3} และ ${b3} จงหา ความยาวของด้านตรงข้ามมุมฉาก (ปัด 2 ตำแหน่ง)`;
          q.answer = parseFloat(c3.toFixed(2));
          q.tolerance = 0.05;
          break;
        case 5: // ความรู้เบื้องต้นเกี่ยวกับจำนวนจริง
          const val = (randInt(1, 9) / randInt(2, 10)).toFixed(3);
          q.prompt = `จำแนกจำนวน ${val} ว่าเป็นจำนวนตรรกยะหรืออตรรกยะ? (พิมพ์ 'ตรรกยะ' หรือ 'อตรรกยะ')`;
          q.type = "text";
          q.answer = "ตรรกยะ";
          q.tolerance = 0;
          break;
        case 6: // ปริซึมและทรงกระบอก
          const areaBase = randInt(5, 20);
          const heightP = randInt(2, 8);
          q.prompt = `ปริมาตรของปริซึม = พื้นที่ฐาน×สูง หากพื้นที่ฐาน = ${areaBase} และสูง = ${heightP} ปริมาตรเท่ากับเท่าไร?`;
          q.answer = areaBase * heightP;
          q.type = "numeric";
          q.tolerance = 0;
          break;
        case 7: // การแปลงทางเรขาคณิต
          const scale = randInt(2, 5);
          const original = randInt(3, 12);
          q.prompt = `ถ้าขนาดถูกขยายด้วยอัตราส่วน ${scale}:1 ความยาวเดิม ${original} จะกลายเป็นเท่าไร?`;
          q.answer = original * scale;
          q.tolerance = 0;
          break;
        case 8: // สมบัติของเลขยกกำลัง
          const base4 = randInt(2, 5);
          q.prompt = `ถ้า a^3 × a^2 = a^? ค่าที่ถูกต้องคือเท่าไร?`;
          q.answer = 5;
          q.type = "numeric";
          q.tolerance = 0;
          break;
        case 9: // พหุนาม
          const coefA = randInt(1, 5);
          const xVal = randInt(1, 5);
          q.prompt = `ให้พหุนาม ${coefA}x + ${coefA} เมื่อ x = ${xVal} ค่าเท่ากับเท่าไร?`;
          q.answer = coefA * xVal + coefA;
          q.tolerance = 0;
          break;
        default:
          q.prompt = "โจทย์ทั่วไป: 2+2 = ?";
          q.answer = 4;
      }
    }

    return q;
  }

  function randInt(a, b) {
    return Math.floor(Math.random() * (b - a + 1)) + a;
  }

  // Actions: when pressing an action for a player
  function openActionFor(i) {
    setActionPickerOpenFor(i);
    setCurrentPlayerIndex(i);
    setStage("action");
  }

  function handleChooseAnswerPressure(hasPressure) {
    // set pressure for current player
    setPressureCard((p) => ({ ...p, [currentPlayerIndex]: hasPressure }));
    // adjust attempts available
    const attempts = hasPressure ? 2 : 5;
    setMaxAttempts(attempts);
    setAttemptsLeft(attempts);
    setStage("action");
  }

  function handleStartQuestion(typeChoice) {
    // typeChoice: '?' or '!?'
    const q = generateQuestion();
    setCurrentQuestion(q);
    setAnswerInput("");
    // set timer
    const hasPressure = !!pressureCard[currentPlayerIndex];
    let seconds = 0;
    if (typeChoice === "?") seconds = 180; // 3 minutes
    if (typeChoice === "!?") seconds = 60; // 1 minute
    if (hasPressure) {
      if (typeChoice === "?") {
        // chances 2 instead of 5
        setMaxAttempts(2);
        setAttemptsLeft(2);
      }
      if (typeChoice === "!?") {
        seconds = 45; // 45 sec
      }
    }
    setQuestionTimer(seconds);
    setStage("question");
    setMessage("");
  }

  function handleSubmitAnswer() {
    if (!currentQuestion) return;
    // Evaluate answer
    const result = evaluateAnswer(currentQuestion, answerInput);
    if (result.correct) {
      // award points
      const playersCopy = [...players];
      playersCopy[currentPlayerIndex].score += 1; // คะแนน +1
      // if it was !? they also get 100 แต้ม
      if (message?.lastSpeedChoice === "!?" || currentQuestion?.lastSpeedChoice === "!?") {
        playersCopy[currentPlayerIndex].points += 100;
      }
      setPlayers(playersCopy);
      clearInterval(timerRef.current);
      timerRef.current = null;
      setQuestionTimer(0);
      setStage("action");
      setMessage("คำตอบถูกต้อง!");
      return;
    } else {
      // wrong
      const remain = attemptsLeft - 1;
      setAttemptsLeft(remain);
      if (remain <= 0) {
        clearInterval(timerRef.current);
        timerRef.current = null;
        setQuestionTimer(0);
        setStage("action");
        setMessage("ตอบไม่สำเร็จ");
      } else {
        setMessage("คำตอบผิดหล่ะ!");
      }
    }
  }

  function handleTimeUp() {
    setMessage("หมดเวลา!");
    setStage("action");
    setCurrentQuestion(null);
  }

  function evaluateAnswer(q, userRaw) {
    const user = (userRaw || "").toString().trim();
    if (q.type === "numeric" || q.type === "") {
      const expected = q.answer;
      // parse user number
      const parsed = parseFloat(user.replace(/,/g, ""));
      if (Number.isNaN(parsed)) return { correct: false };
      if (q.tolerance === 0) {
        return { correct: Math.abs(parsed - expected) < 1e-6 };
      }
      // relative tolerance or absolute small
      const rel = Math.abs(parsed - expected);
      if (rel <= q.tolerance || rel / Math.max(1, Math.abs(expected)) <= q.tolerance) return { correct: true };
      return { correct: false };
    }
    if (q.type === "list") {
      // expect comma separated numbers
      const expectedList = q.answer.map((v) => v.toString());
      const got = user.replace(/\s+/g, "").split(/[,;]/).map((s) => s.trim()).filter(Boolean);
      // check if all expected included (order-insensitive)
      const ok = expectedList.every((e) => got.includes(e));
      return { correct: ok };
    }
    if (q.type === "text") {
      const got = user.toLowerCase();
      const exp = (q.answer || "").toString().toLowerCase();
      // allow closeness if contains substring
      return { correct: got.includes(exp) || exp.includes(got) };
    }
    // fallback
    return { correct: user === String(q.answer) };
  }

  function renderChoosePlayers() {
    return (
      <div className="p-4">
        <h2 className="text-xl font-bold mb-4">เลือกจำนวนผู้เล่น</h2>
        <div className="flex gap-3">
          {[2, 3, 4].map((n) => (
            <button
              key={n}
              onClick={() => {
                setPlayerCount(n);
                setStage("chooseLevel");
              }}
              className={`px-4 py-2 rounded shadow ${playerCount === n ? "bg-blue-500 text-white" : "bg-white"}`}
            >
              {n} คน
            </button>
          ))}
        </div>
      </div>
    );
  }

  function renderChooseLevel() {
    return (
      <div className="p-4">
        <h2 className="text-xl font-bold mb-4">เลือกระดับความยาก</h2>
        <div className="flex gap-3">
          <button
            onClick={() => {
              setLevel("m1");
              setStage("choosePlayerNumber");
            }}
            className={`px-4 py-2 rounded shadow ${level === "m1" ? "bg-green-500 text-white" : "bg-white"}`}
          >
            ม.1
          </button>
          <button
            onClick={() => {
              setLevel("m2");
              setStage("choosePlayerNumber");
            }}
            className={`px-4 py-2 rounded shadow ${level === "m2" ? "bg-green-500 text-white" : "bg-white"}`}
          >
            ม.2
          </button>
        </div>
      </div>
    );
  }

  function renderChoosePlayerNumber() {
    return (
      <div className="p-4">
        <h2 className="text-xl font-bold mb-4">เลือกหมายเลขผู้เล่นของคุณ</h2>
        <div className="flex gap-3">
          {Array.from({ length: playerCount }).map((_, i) => (
            <button
              key={i}
              onClick={() => {
                setCurrentPlayerIndex(i);
                setStage("action");
              }}
              className={`px-3 py-2 rounded shadow ${currentPlayerIndex === i ? "bg-indigo-500 text-white" : "bg-white"}`}
            >
              ผู้เล่นที่ {i + 1}
            </button>
          ))}
        </div>
      </div>
    );
  }

  function renderAction() {
    return (
      <div className="p-4">
        <h2 className="text-xl font-bold mb-3">เลือกแอคชั่น</h2>
        <div className="mb-2">คะแนน : {players[currentPlayerIndex]?.score ?? 0} &nbsp;&nbsp; แต้ม : {players[currentPlayerIndex]?.points ?? 0}</div>
        <div className="flex gap-3 mb-4">
          <button
            onClick={() => setStage("choosePressure")}
            className="px-4 py-2 rounded bg-yellow-200"
          >
            ตอบคำถาม
          </button>
          <button
            onClick={() => alert('ฟีเจอร์ร้านค้ายังเป็นแบบตัวอย่าง — คุณสามารถเพิ่มโลจิกการซื้อของได้')}
            className="px-4 py-2 rounded bg-gray-200"
          >
            ซื้อของจากร้านค้า
          </button>
        </div>
        <div className="mt-4">
          <h3 className="font-semibold">สถานะผู้เล่นทั้งหมด</h3>
          <div className="flex gap-2 mt-2">
            {players.map((p, idx) => (
              <div key={idx} className="p-2 border rounded">
                ผู้เล่น {idx + 1}
                <div>คะแนน: {p.score}</div>
                <div>แต้ม: {p.points}</div>
                <div>การ์ดความกดดัน: {pressureCard[idx] ? 'มี' : 'ไม่มี'}</div>
                <div>
                  <button onClick={() => openActionFor(idx)} className="text-sm underline">เลือก</button>
                </div>
              </div>
            ))}
          </div>
        </div>
        {message && <div className="mt-3 p-2 bg-red-50 rounded">{message}</div>}
      </div>
    );
  }

  function renderChoosePressure() {
    return (
      <div className="p-4">
        <h3 className="text-lg font-bold">คุณมีการ์ดความกดดันที่มากขึ้นหรือไม่?</h3>
        <div className="flex gap-3 mt-3">
          <button onClick={() => handleChooseAnswerPressure(true)} className="px-3 py-2 rounded bg-red-200">มี</button>
          <button onClick={() => handleChooseAnswerPressure(false)} className="px-3 py-2 rounded bg-green-200">ไม่มี</button>
        </div>
      </div>
    );
  }

  function renderQuestionTypeChoice() {
    return (
      <div className="p-4">
        <h3 className="font-bold">เลือกรูปแบบการตอบ</h3>
        <div className="flex gap-3 mt-3">
          <button
            onClick={() => handleStartQuestion("?")}
            className="px-4 py-2 rounded bg-blue-100"
          >
            ? (3 นาที)
          </button>
          <button
            onClick={() => handleStartQuestion("!?")}
            className="px-4 py-2 rounded bg-yellow-100"
          >
            !? (1 นาที)
          </button>
        </div>
        <div className="mt-2 text-sm text-gray-600">(หากผู้เล่นมีการ์ดความกดดัน เวลาของ ? จะเหลือโอกาสตอบ 2 ครั้ง และ !? จะเหลือ 45 วินาที)</div>
      </div>
    );
  }

  function renderQuestionUI() {
    if (!currentQuestion) return null;
    return (
      <div className="p-4">
        <h3 className="font-bold mb-2">คำถาม</h3>
        <div className="mb-2">{currentQuestion.prompt}</div>
        <div className="mb-2">เวลาเหลือ: {formatTime(questionTimer)}</div>
        <div className="mb-2">โอกาสที่เหลือ: {attemptsLeft}</div>
        <input
          value={answerInput}
          onChange={(e) => setAnswerInput(e.target.value)}
          placeholder="พิมพ์คำตอบที่นี่"
          className="border p-2 rounded w-full mb-2"
        />
        <div className="flex gap-2">
          <button onClick={handleSubmitAnswer} className="px-3 py-2 rounded bg-green-300">ส่งคำตอบ</button>
          <button onClick={() => { setStage('action'); clearInterval(timerRef.current); timerRef.current=null; setQuestionTimer(0); }} className="px-3 py-2 rounded bg-gray-200">ยกเลิก</button>
        </div>
        {message && <div className="mt-2 text-red-600">{message}</div>}
      </div>
    );
  }

  function formatTime(s) {
    const mm = Math.floor(s / 60).toString().padStart(2, "0");
    const ss = (s % 60).toString().padStart(2, "0");
    return `${mm}:${ss}`;
  }

  // main render
  return (
    <div className="max-w-3xl mx-auto p-4" style={{ fontFamily: 'Inter, system-ui, -apple-system, Roboto, "Helvetica Neue", Arial' }}>
      <h1 className="text-2xl font-extrabold mb-4">บอร์ดเกมคณิตคิดสนุก Setup!</h1>
      <div className="mb-4 p-3 border rounded bg-gray-50">
        สถานะเกม: {stage}
      </div>
      <div className="mb-4">โลจิก:
        <ul className="list-disc ml-6">
          <li>เลือกระดับผู้เล่น → ระดับ → หมายเลขผู้เล่น → เลือกแอคชั่น</li>
          <li>ตอบคำถาม: ถ้าถูก +1 คะแนน, ถ้าเลือก !? ถูกได้ +100 แต้มเพิ่มเติม</li>
          <li>ถ้าตอบผิดหรือหมดเวลาจะกลับหน้าเลือกแอคชั่น</li>
          <li>OpenAI/AI analysis: ระบบจะประเมินว่าคำตอบใกล้เคียงหรือไม่โดยยอมรับค่าภายในค่าความคลาดเคลื่อน (tolerance)</li>
        </ul>
      </div>

      <div className="bg-white p-4 rounded shadow">
        {stage === 'choosePlayers' && renderChoosePlayers()}
        {stage === 'chooseLevel' && renderChooseLevel()}
        {stage === 'choosePlayerNumber' && renderChoosePlayerNumber()}
        {stage === 'action' && renderAction()}
        {stage === 'choosePressure' && renderChoosePressure()}
        {stage === 'questionType' && renderQuestionTypeChoice()}
        {stage === 'question' && renderQuestionUI()}
      </div>

      <div className="mt-6 text-sm text-gray-600">
        หมายเหตุ: โค้ดนี้เป็นตัวอย่างที่ครบวงจรสำหรับการเล่นเบื้องต้น — คุณสามารถปรับแต่งข้อความโจทย์ให้หลากหลายขึ้น เพิ่มการเช็คคำตอบเชิงสัญลักษณ์ หรือเชื่อมต่อกับ OpenAI API เพื่อให้ AI สร้างโจทย์และวิเคราะห์เชิงลึกได้ (ส่วนนี้ให้ผู้พัฒนาเพิ่มคีย์และเรียก API ด้วยตนเอง)
      </div>
    </div>
  );
}
